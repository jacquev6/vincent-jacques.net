---
---
<table border=1><tr><th>Rank</th><th>Combination</th><th>First throw</th><th>Second throw</th></tr>
<tr><td>1</td><td><span style="font-size: 200%">⚃⚁⚀</span></td><td>Keep all</td><td>Keep all</td></tr>
<tr><td>2</td><td><span style="font-size: 200%">⚀⚀⚀</span></td><td>Keep all</td><td>Keep all</td></tr>
<tr><td>3</td><td><span style="font-size: 200%">⚀⚀⚅</span></td><td>Keep all</td><td>Keep all</td></tr>
<tr><td>4</td><td><span style="font-size: 200%">⚀⚀⚄</span></td><td>Keep <span style="font-size: 200%">⚀⚀</span></td><td>Keep all</td></tr>
<tr><td>5</td><td><span style="font-size: 200%">⚀⚀⚃</span></td><td>Keep <span style="font-size: 200%">⚀⚀</span></td><td>Keep <span style="font-size: 200%">⚀⚀</span></td></tr>
<tr><td>6</td><td><span style="font-size: 200%">⚀⚀⚂</span></td><td>Keep <span style="font-size: 200%">⚀⚀</span></td><td>Keep <span style="font-size: 200%">⚀⚀</span></td></tr>
<tr><td>7</td><td><span style="font-size: 200%">⚀⚀⚁</span></td><td>Keep <span style="font-size: 200%">⚀⚀</span></td><td>Keep <span style="font-size: 200%">⚀⚀</span></td></tr>
<tr><td>8</td><td><span style="font-size: 200%">⚅⚅⚅</span></td><td>Keep all</td><td>Keep all</td></tr>
<tr><td>9</td><td><span style="font-size: 200%">⚄⚄⚄</span></td><td>Keep all</td><td>Keep all</td></tr>
<tr><td>10</td><td><span style="font-size: 200%">⚃⚃⚃</span></td><td>Keep all</td><td>Keep all</td></tr>
<tr><td>11</td><td><span style="font-size: 200%">⚂⚂⚂</span></td><td>Keep all</td><td>Keep all</td></tr>
<tr><td>12</td><td><span style="font-size: 200%">⚁⚁⚁</span></td><td>Keep all</td><td>Keep all</td></tr>
<tr><td>13</td><td><span style="font-size: 200%">⚃⚄⚅</span></td><td>Keep all</td><td>Keep all</td></tr>
<tr><td>14</td><td><span style="font-size: 200%">⚂⚃⚄</span></td><td>Keep all</td><td>Keep all</td></tr>
<tr><td>15</td><td><span style="font-size: 200%">⚁⚂⚃</span></td><td>Keep all</td><td>Keep all</td></tr>
<tr><td>16</td><td><span style="font-size: 200%">⚀⚁⚂</span></td><td>Keep <span style="font-size: 200%">⚀⚁</span></td><td>Keep all</td></tr>
<tr><td>17</td><td><span style="font-size: 200%">⚅⚅⚄</span></td><td>Keep <span style="font-size: 200%">⚅⚅</span></td><td>Keep all</td></tr>
<tr><td>18</td><td><span style="font-size: 200%">⚅⚅⚃</span></td><td>Keep <span style="font-size: 200%">⚅⚅</span></td><td>Keep <span style="font-size: 200%">⚅⚅</span></td></tr>
<tr><td>19</td><td><span style="font-size: 200%">⚅⚅⚂</span></td><td>Keep <span style="font-size: 200%">⚅⚅</span></td><td>Keep <span style="font-size: 200%">⚅⚅</span></td></tr>
<tr><td>20</td><td><span style="font-size: 200%">⚅⚅⚁</span></td><td>Keep <span style="font-size: 200%">⚅⚅</span></td><td>Keep <span style="font-size: 200%">⚅⚅</span></td></tr>
<tr><td>21</td><td><span style="font-size: 200%">⚅⚅⚀</span></td><td>Keep <span style="font-size: 200%">⚅⚅</span></td><td>Keep <span style="font-size: 200%">⚅⚅</span></td></tr>
<tr><td>22</td><td><span style="font-size: 200%">⚅⚄⚄</span></td><td>Keep <span style="font-size: 200%">⚄⚅</span></td><td>Keep <span style="font-size: 200%">⚄⚅</span></td></tr>
<tr><td>23</td><td><span style="font-size: 200%">⚅⚄⚂</span></td><td>Keep <span style="font-size: 200%">⚄⚅</span></td><td>Keep <span style="font-size: 200%">⚄⚅</span></td></tr>
<tr><td>24</td><td><span style="font-size: 200%">⚅⚄⚁</span></td><td>Keep <span style="font-size: 200%">⚄⚅</span></td><td>Keep <span style="font-size: 200%">⚄⚅</span></td></tr>
<tr><td>25</td><td><span style="font-size: 200%">⚅⚄⚀</span></td><td>Keep <span style="font-size: 200%">⚀</span></td><td>Keep <span style="font-size: 200%">⚄⚅</span></td></tr>
<tr><td>26</td><td><span style="font-size: 200%">⚅⚃⚃</span></td><td>Keep <span style="font-size: 200%">⚅</span></td><td>Keep <span style="font-size: 200%">⚅</span></td></tr>
<tr><td>27</td><td><span style="font-size: 200%">⚅⚃⚂</span></td><td>Keep <span style="font-size: 200%">⚅</span></td><td>Keep <span style="font-size: 200%">⚅</span></td></tr>
<tr><td>28</td><td><span style="font-size: 200%">⚅⚃⚁</span></td><td>Keep <span style="font-size: 200%">⚅</span></td><td>Keep <span style="font-size: 200%">⚅</span></td></tr>
<tr><td>29</td><td><span style="font-size: 200%">⚅⚃⚀</span></td><td>Keep <span style="font-size: 200%">⚀</span></td><td>Keep <span style="font-size: 200%">⚅</span></td></tr>
<tr><td>30</td><td><span style="font-size: 200%">⚅⚂⚂</span></td><td>Keep <span style="font-size: 200%">⚅</span></td><td>Keep <span style="font-size: 200%">⚅</span></td></tr>
<tr><td>31</td><td><span style="font-size: 200%">⚅⚂⚁</span></td><td>Keep <span style="font-size: 200%">⚅</span></td><td>Keep <span style="font-size: 200%">⚅</span></td></tr>
<tr><td>32</td><td><span style="font-size: 200%">⚅⚂⚀</span></td><td>Keep <span style="font-size: 200%">⚀</span></td><td>Keep <span style="font-size: 200%">⚅</span></td></tr>
<tr><td>33</td><td><span style="font-size: 200%">⚅⚁⚁</span></td><td>Keep <span style="font-size: 200%">⚅</span></td><td>Keep <span style="font-size: 200%">⚅</span></td></tr>
<tr><td>34</td><td><span style="font-size: 200%">⚅⚁⚀</span></td><td>Keep <span style="font-size: 200%">⚀⚁</span></td><td>Keep <span style="font-size: 200%">⚅</span></td></tr>
<tr><td>35</td><td><span style="font-size: 200%">⚄⚄⚃</span></td><td>Rethrow all</td><td>Keep <span style="font-size: 200%">⚄⚄</span></td></tr>
<tr><td>36</td><td><span style="font-size: 200%">⚄⚄⚂</span></td><td>Rethrow all</td><td>Keep <span style="font-size: 200%">⚄⚄</span></td></tr>
<tr><td>37</td><td><span style="font-size: 200%">⚄⚄⚁</span></td><td>Rethrow all</td><td>Keep <span style="font-size: 200%">⚄⚄</span></td></tr>
<tr><td>38</td><td><span style="font-size: 200%">⚄⚄⚀</span></td><td>Keep <span style="font-size: 200%">⚀</span></td><td>Keep <span style="font-size: 200%">⚀</span></td></tr>
<tr><td>39</td><td><span style="font-size: 200%">⚄⚃⚃</span></td><td>Rethrow all</td><td>Rethrow all</td></tr>
<tr><td>40</td><td><span style="font-size: 200%">⚄⚃⚁</span></td><td>Rethrow all</td><td>Rethrow all</td></tr>
<tr><td>41</td><td><span style="font-size: 200%">⚄⚃⚀</span></td><td>Keep <span style="font-size: 200%">⚀</span></td><td>Keep <span style="font-size: 200%">⚀</span></td></tr>
<tr><td>42</td><td><span style="font-size: 200%">⚄⚂⚂</span></td><td>Rethrow all</td><td>Rethrow all</td></tr>
<tr><td>43</td><td><span style="font-size: 200%">⚄⚂⚁</span></td><td>Rethrow all</td><td>Rethrow all</td></tr>
<tr><td>44</td><td><span style="font-size: 200%">⚄⚂⚀</span></td><td>Keep <span style="font-size: 200%">⚀</span></td><td>Keep <span style="font-size: 200%">⚀</span></td></tr>
<tr><td>45</td><td><span style="font-size: 200%">⚄⚁⚁</span></td><td>Rethrow all</td><td>Rethrow all</td></tr>
<tr><td>46</td><td><span style="font-size: 200%">⚄⚁⚀</span></td><td>Keep <span style="font-size: 200%">⚀⚁</span></td><td>Keep <span style="font-size: 200%">⚀</span></td></tr>
<tr><td>47</td><td><span style="font-size: 200%">⚃⚃⚂</span></td><td>Rethrow all</td><td>Rethrow all</td></tr>
<tr><td>48</td><td><span style="font-size: 200%">⚃⚃⚁</span></td><td>Rethrow all</td><td>Rethrow all</td></tr>
<tr><td>49</td><td><span style="font-size: 200%">⚃⚃⚀</span></td><td>Keep <span style="font-size: 200%">⚀</span></td><td>Keep <span style="font-size: 200%">⚀</span></td></tr>
<tr><td>50</td><td><span style="font-size: 200%">⚃⚂⚂</span></td><td>Rethrow all</td><td>Rethrow all</td></tr>
<tr><td>51</td><td><span style="font-size: 200%">⚃⚂⚀</span></td><td>Keep <span style="font-size: 200%">⚀</span></td><td>Keep <span style="font-size: 200%">⚀</span></td></tr>
<tr><td>52</td><td><span style="font-size: 200%">⚃⚁⚁</span></td><td>Rethrow all</td><td>Rethrow all</td></tr>
<tr><td>53</td><td><span style="font-size: 200%">⚂⚂⚁</span></td><td>Rethrow all</td><td>Rethrow all</td></tr>
<tr><td>54</td><td><span style="font-size: 200%">⚂⚂⚀</span></td><td>Keep <span style="font-size: 200%">⚀</span></td><td>Keep <span style="font-size: 200%">⚀</span></td></tr>
<tr><td>55</td><td><span style="font-size: 200%">⚂⚁⚁</span></td><td>Rethrow all</td><td>Rethrow all</td></tr>
<tr><td>56</td><td><span style="font-size: 200%">⚁⚁⚀</span></td><td>Keep <span style="font-size: 200%">⚀⚁</span></td><td>Keep <span style="font-size: 200%">⚀</span></td></tr>
</table>

<!--
#!/usr/bin/env python3

import itertools
import sys
import unittest


combinations = [
    (4, 2, 1),
    (1, 1, 1), (1, 1, 6), (1, 1, 5), (1, 1, 4), (1, 1, 3), (1, 1, 2),
    (6, 6, 6), (5, 5, 5), (4, 4, 4), (3, 3, 3), (2, 2, 2),
    (4, 5, 6), (3, 4, 5), (2, 3, 4), (1, 2, 3),

    (6, 6, 5), (6, 6, 4), (6, 6, 3), (6, 6, 2), (6, 6, 1),
    (6, 5, 5), (6, 5, 3), (6, 5, 2), (6, 5, 1),
    (6, 4, 4), (6, 4, 3), (6, 4, 2), (6, 4, 1),
    (6, 3, 3), (6, 3, 2), (6, 3, 1),
    (6, 2, 2), (6, 2, 1),
    (5, 5, 4), (5, 5, 3), (5, 5, 2), (5, 5, 1),
    (5, 4, 4), (5, 4, 2), (5, 4, 1),
    (5, 3, 3), (5, 3, 2), (5, 3, 1),
    (5, 2, 2), (5, 2, 1),
    (4, 4, 3), (4, 4, 2), (4, 4, 1),
    (4, 3, 3), (4, 3, 1),
    (4, 2, 2),
    (3, 3, 2), (3, 3, 1),
    (3, 2, 2),
    (2, 2, 1),
]


class Ranker:
    def __init__(self, ranks):
        # print(ranks)
        self.__public_combinations = {tuple(sorted(dice)): dice for dice in ranks.keys()}
        # print(self.__public_combinations)
        self.__ranks = {tuple(sorted(dice)): rank for dice, rank in ranks.items()}
        self.__faces = frozenset(itertools.chain.from_iterable(self.__ranks.keys()))
        for key in self.__ranks.keys():
            self.__dice_count = len(key)
            break
        for dice in itertools.product(self.__faces, repeat=self.__dice_count):
            assert tuple(sorted(dice)) in self.__ranks
        self.__memo = {}

    def get_dice_to_keep(self, dice, remaining_throws):
        assert len(dice) == self.__dice_count
        assert all(die in self.__faces for die in dice)
        assert isinstance(remaining_throws, int)
        assert remaining_throws >= 0

        dice = tuple(sorted(dice))
        key = (dice, remaining_throws)

        if key not in self.__memo:
            self.__memo[key] = self.__get_dice_to_keep(dice, remaining_throws)
        return self.__memo[key]

    def __get_dice_to_keep(self, dice, remaining_throws):
        best_rank = self.__ranks[dice]
        best_keep = dice

        if remaining_throws != 0:
            # print("remaining_throws", remaining_throws)
            for keep_count in range(self.__dice_count + 1):
                for keep in itertools.combinations(dice, keep_count):
                    # print("keep", keep)
                    ranks = []
                    for new in itertools.product(self.__faces, repeat=self.__dice_count - keep_count):
                        candidate_dice = tuple(itertools.chain(keep, new))
                        candidate_rank, candidate_keep = self.get_dice_to_keep(candidate_dice, remaining_throws - 1)
                        ranks.append(candidate_rank)
                    average_rank = sum(ranks) / len(ranks)
                    # print("average_rank", average_rank)
                    if average_rank > best_rank:
                        best_rank = average_rank
                        best_keep = keep
        if len(best_keep) == self.__dice_count:
            best_keep = self.__public_combinations[best_keep]
        return best_rank, best_keep


class TwoSmallDiceWithMonotonicRanksRankerTestCase(unittest.TestCase):
    def setUp(self):
        self.ranker = Ranker({(0, 0): 0, (0, 1): 1, (1, 1): 2})

    def test_no_rethrows(self):
        self.assertEqual(self.ranker.get_dice_to_keep((0, 0), 0), (0, (0, 0)))
        self.assertEqual(self.ranker.get_dice_to_keep((0, 1), 0), (1, (0, 1)))
        self.assertEqual(self.ranker.get_dice_to_keep((1, 1), 0), (2, (1, 1)))

    def test_one_rethrow(self):
        self.assertEqual(self.ranker.get_dice_to_keep((0, 0), 1), (1, ()))
        self.assertEqual(self.ranker.get_dice_to_keep((0, 1), 1), (1.5, (1,)))
        self.assertEqual(self.ranker.get_dice_to_keep((1, 1), 1), (2, (1, 1)))

    def test_two_rethrows(self):
        self.assertEqual(self.ranker.get_dice_to_keep((0, 0), 2), (1.5, ()))
        self.assertEqual(self.ranker.get_dice_to_keep((0, 1), 2), (1.75, (1,)))
        self.assertEqual(self.ranker.get_dice_to_keep((1, 1), 2), (2, (1, 1)))

    def test_three_rethrows(self):
        self.assertEqual(self.ranker.get_dice_to_keep((0, 0), 3), (1.75, ()))
        self.assertEqual(self.ranker.get_dice_to_keep((0, 1), 3), (1.875, (1,)))
        self.assertEqual(self.ranker.get_dice_to_keep((1, 1), 3), (2, (1, 1)))


class Real421GameRankerTestCase(unittest.TestCase):
    def setUp(self):
        self.ranker = Ranker({dice: (len(combinations) - rank) for rank, dice in enumerate(combinations)})

    def test_known_good_scores(self):
        self.assertEqual(self.ranker.get_dice_to_keep((4, 2, 1), 2), (56, (4, 2, 1)))
        self.assertEqual(self.ranker.get_dice_to_keep((1, 1, 1), 2), (55, (1, 1, 1)))
        self.assertEqual(self.ranker.get_dice_to_keep((1, 1, 6), 2), (54, (1, 1, 6)))

    def test_known_improvable_scores(self):
        self.assertEqual(self.ranker.get_dice_to_keep((1, 1, 5), 2), (53.25, (1, 1)))
        self.assertEqual(self.ranker.get_dice_to_keep((1, 1, 4), 2), (53.25, (1, 1)))
        self.assertEqual(self.ranker.get_dice_to_keep((1, 1, 3), 2), (53.25, (1, 1)))
        self.assertEqual(self.ranker.get_dice_to_keep((1, 1, 2), 2), (53.25, (1, 1)))

    def test_scores_that_give_aces(self):
        self.assertEqual(self.ranker.get_dice_to_keep((3, 3, 1), 2), (40.92129629629631, (1,)))
        self.assertEqual(self.ranker.get_dice_to_keep((4, 3, 1), 2), (40.92129629629631, (1,)))

    def test_scores_that_give_421(self):
        self.assertEqual(self.ranker.get_dice_to_keep((2, 2, 1), 2), (41.10185185185185, (1, 2)))

    def test_known_bad_scores(self):
        self.assertEqual(self.ranker.get_dice_to_keep((4, 2, 2), 2), (35.9571116255144, ()))
        self.assertEqual(self.ranker.get_dice_to_keep((3, 3, 2), 2), (35.9571116255144, ()))
        self.assertEqual(self.ranker.get_dice_to_keep((3, 2, 2), 2), (35.9571116255144, ()))

    def test_generate_html(self):
        def format_die(die):
            return {
                1: u"\u2680",
                2: u"\u2681",
                3: u"\u2682",
                4: u"\u2683",
                5: u"\u2684",
                6: u"\u2685",
            }[die]

        def format_dice(dice):
            return u'<span style="font-size: 300%">{}</span>'.format(u"".join(format_die(die) for die in dice))

        def format_keep(dice, target, keep):
            if keep == dice:
                return "Keep all"
            elif keep == ():
                return "Rethrow all"
            else:
                return "Keep {}".format(format_dice(keep))

        with open("421.html", "w") as f:
            f.write('<html><head> <meta charset="UTF-8"><title>421 strategies</title></head><body>\n\n')
            f.write("<table border=1><tr><th>Rank</th><th>Combination</th><th>First throw</th><th>Second throw</th></tr>\n")
            for rank, dice in enumerate(combinations):
                first = self.ranker.get_dice_to_keep(dice, 2)
                second = self.ranker.get_dice_to_keep(dice, 1)
                f.write("<tr><td>{}</td><td>{}</td><td>{}</td><td>{}</td></tr>\n".format(rank + 1, format_dice(dice), format_keep(dice, *first), format_keep(dice, *second)))
                # break
            f.write("</table>\n\n</body></html>")


if __name__ == "__main__":
    unittest.main()

-->
